<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EvilTwins.cloud | Juice WRLD</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- HLS.js for Streaming -->
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <!-- Custom Styles -->
    <style>
        /* Custom scrollbar for a cleaner look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1f2937; /* gray-800 */
        }
        ::-webkit-scrollbar-thumb {
            background: #4b5563; /* gray-600 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* gray-500 */
        }
        /* Style for the active/currently playing song */
        .song-item.active {
            background-color: #374151; /* gray-700 */
        }
    </style>
</head>
<body class="font-sans antialiased">

    <!-- This video tag is used by hls.js to play the audio. It's hidden from view. -->
    <video id="audioPlayer" class="hidden" playsinline></video>

    <div class="flex flex-col h-screen">
        <!-- Header / Search Bar / User Profile -->
        <header class="flex items-center justify-between p-4 bg-gray-900/80 backdrop-blur-sm sticky top-0 z-20 border-b border-gray-800">
            <div class="text-xl font-bold tracking-wider">
                <a href="/">EvilTwins</a>
            </div>
            <div class="relative w-full md:w-1/2 max-w-md">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                <input type="text" id="searchInput" placeholder="Search for a song..." class="w-full bg-gray-800 rounded-full py-2 pl-12 pr-4 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all">
            </div>
            <div id="user-auth-container" class="flex-shrink-0">
                <!-- User profile or Login button will be injected here by JS -->
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex flex-col md:flex-row overflow-y-hidden">
            <!-- Left Panel: Playlist & Info -->
            <div class="w-full md:w-1/3 lg:w-1/4 flex flex-col p-4 space-y-4 overflow-y-auto">
                <!-- Artist Info -->
                <div class="text-center">
                    <!-- FIXED: Updated image URL to one that is functional -->
                    <img src="https://i.scdn.co/image/ab6761610000e5eb1e9213969566a54f43d31481" alt="Juice WRLD" class="w-32 h-32 md:w-48 md:h-48 mx-auto rounded-full object-cover shadow-lg">
                    <h1 class="text-3xl font-bold mt-4">Juice WRLD</h1>
                    <p class="text-gray-400">Unreleased Music Collection</p>
                </div>
                <!-- Top Tracks -->
                <div>
                    <h2 class="text-xl font-semibold mb-2">Most Listened</h2>
                    <div id="top-tracks-list" class="space-y-2">
                        <!-- Top tracks will be injected here by JS -->
                        <p class="text-gray-500 p-2">Tracking listens...</p>
                    </div>
                </div>
                <!-- Playlist -->
                <div>
                    <h2 class="text-xl font-semibold mb-2">Library</h2>
                    <div id="playlist" class="space-y-1">
                        <!-- Playlist items will be injected here by JS -->
                        <div class="text-center p-8">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <p class="mt-2">Loading music library...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel: Lyrics -->
            <div id="lyrics-section" class="w-full md:w-2/3 lg:w-3/4 bg-gray-900/50 p-6 overflow-y-auto hidden md:block">
                 <div class="text-center sticky top-0 bg-gray-900 py-4">
                    <h2 class="text-2xl font-bold" id="lyrics-song-title">Lyrics</h2>
                    <p class="text-gray-400" id="lyrics-song-artist">Select a song to see lyrics</p>
                </div>
                <div id="lyrics-content" class="mt-6 text-gray-300 text-lg leading-loose whitespace-pre-wrap text-center">
                    <!-- Lyrics will be injected here by JS -->
                    <i class="fas fa-music text-4xl text-gray-600"></i>
                </div>
            </div>
        </main>

        <!-- Music Player Bar -->
        <footer class="bg-gray-800 p-3 shadow-t-lg sticky bottom-0 z-20">
            <div class="flex items-center">
                <!-- Song Info -->
                <div class="w-1/4 flex items-center min-w-0">
                    <img id="player-album-art" src="https://placehold.co/64x64/1f2937/4b5563?text=?" alt="Album Art" class="w-14 h-14 rounded-md shadow-md flex-shrink-0">
                    <div class="ml-3 truncate">
                        <p id="player-song-title" class="font-bold truncate">Select a song</p>
                        <p id="player-song-artist" class="text-sm text-gray-400 truncate">No artist</p>
                    </div>
                </div>

                <!-- Player Controls -->
                <div class="w-1/2 flex flex-col items-center">
                    <div class="flex items-center space-x-6">
                        <button id="prevBtn" class="text-gray-400 hover:text-white transition"><i class="fas fa-backward-step fa-lg"></i></button>
                        <button id="playPauseBtn" class="bg-white text-black rounded-full w-10 h-10 flex items-center justify-center hover:scale-105 transition shadow-lg">
                            <i id="playPauseIcon" class="fas fa-play"></i>
                        </button>
                        <button id="nextBtn" class="text-gray-400 hover:text-white transition"><i class="fas fa-forward-step fa-lg"></i></button>
                    </div>
                    <div class="w-full max-w-md flex items-center space-x-2 mt-2">
                        <span id="currentTime" class="text-xs text-gray-400">0:00</span>
                        <input id="seekBar" type="range" value="0" step="1" class="w-full h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                        <span id="duration" class="text-xs text-gray-400">0:00</span>
                    </div>
                </div>

                <!-- Volume & Options -->
                <div class="w-1/4 flex items-center justify-end space-x-4">
                     <button id="downloadBtn" class="text-gray-400 hover:text-white transition" title="Download for Offline Listening">
                        <i class="fas fa-download"></i>
                    </button>
                    <i class="fas fa-volume-high text-gray-400"></i>
                    <input id="volumeBar" type="range" min="0" max="1" step="0.01" value="1" class="w-24 h-1 bg-gray-600 rounded-lg appearance-none cursor-pointer accent-purple-500">
                    <button id="lyricsToggleBtn" class="text-gray-400 hover:text-white transition md:hidden" title="Toggle Lyrics">
                        <i class="fas fa-align-left"></i>
                    </button>
                </div>
            </div>
        </footer>

        <!-- User Account Modal -->
        <div id="accountModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
            <div class="bg-gray-800 rounded-lg p-8 w-full max-w-md m-4">
                <h2 class="text-2xl font-bold mb-4">Account</h2>
                <div id="account-info">
                    <!-- Account details will be injected here -->
                </div>
                <div class="mt-6 flex justify-between items-center">
                    <button id="logoutBtn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded transition">Logout</button>
                     <button id="closeModalBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded transition">Close</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
          apiKey: "AIzaSyA3s7Qf7LHfTkjwTZblA2kuqUv74NBezak",
          authDomain: "eviltwins-cloud.firebaseapp.com",
          projectId: "eviltwins-cloud",
          storageBucket: "eviltwins-cloud.appspot.com",
          messagingSenderId: "771410594940",
          appId: "1:771410594940:web:f4b4d3a167e6759e040df9",
          measurementId: "G-KXYRWMTJH4"
        };

        // Initialize Firebase
        try {
            window.firebaseApp = initializeApp(firebaseConfig);
            window.auth = getAuth(window.firebaseApp);
            window.db = getFirestore(window.firebaseApp);
            setLogLevel('debug'); // Optional: for detailed console logs
            // Signal that Firebase is ready
            document.dispatchEvent(new CustomEvent('firebase-ready'));
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }
    </script>

    <!-- Main Application Logic -->
    <script src="app.js" type="module"></script>
</body>
</html>
```

Now, here is the corrected `app.js` file from the Canvas with the robust initialization logic.


```javascript
import {
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import {
    doc,
    setDoc,
    collection,
    query,
    onSnapshot,
    increment,
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- DOM ELEMENTS ---
const audioPlayer = document.getElementById('audioPlayer');
const playlistContainer = document.getElementById('playlist');
const searchInput = document.getElementById('searchInput');
const playPauseBtn = document.getElementById('playPauseBtn');
const playPauseIcon = document.getElementById('playPauseIcon');
const nextBtn = document.getElementById('nextBtn');
const prevBtn = document.getElementById('prevBtn');
const seekBar = document.getElementById('seekBar');
const volumeBar = document.getElementById('volumeBar');
const currentTimeEl = document.getElementById('currentTime');
const durationEl = document.getElementById('duration');
const playerAlbumArt = document.getElementById('player-album-art');
const playerSongTitle = document.getElementById('player-song-title');
const playerSongArtist = document.getElementById('player-song-artist');
const userAuthContainer = document.getElementById('user-auth-container');
const accountModal = document.getElementById('accountModal');
const closeModalBtn = document.getElementById('closeModalBtn');
const logoutBtn = document.getElementById('logoutBtn');
const accountInfoContainer = document.getElementById('account-info');
const lyricsContent = document.getElementById('lyrics-content');
const lyricsSongTitle = document.getElementById('lyrics-song-title');
const lyricsSongArtist = document.getElementById('lyrics-song-artist');
const topTracksList = document.getElementById('top-tracks-list');
const downloadBtn = document.getElementById('downloadBtn');
const lyricsSection = document.getElementById('lyrics-section');
const lyricsToggleBtn = document.getElementById('lyricsToggleBtn');

// --- APP STATE ---
let hls;
let playlist = [];
let currentIndex = -1;
let isPlaying = false;
let currentUser = null;

const playlistUrl = 'https://raw.githubusercontent.com/oxyisbad222/eviltwins/main/juice.m3u8';
const geniusApiUrl = '/api/lyrics';

// --- INITIALIZATION ---
// **FIXED: This listener is the entry point. It waits for Firebase to be ready.**
document.addEventListener('firebase-ready', main);

/**
 * The main function that kicks off the application logic AFTER firebase is ready.
 */
async function main() {
    console.log("Firebase is ready. Initializing app...");
    
    // Make Firebase services available to the whole script
    const auth = window.auth;
    const db = window.db;

    if (!auth || !db) {
        console.error("Fatal Error: Firebase services are not available on the window object.");
        return;
    }

    try {
        await loadPlaylist();
        setupEventListeners();
        setupAuthObserver(auth);
        setupTopTracksListener(db);
    } catch (error) {
        console.error("An error occurred during app initialization:", error);
    }
}

/**
 * Loads and parses the M3U8 playlist file.
 */
async function loadPlaylist() {
    try {
        // Use a cache-busting query parameter to ensure we get the latest version
        const response = await fetch(`${playlistUrl}?t=${new Date().getTime()}`);
        if (!response.ok) {
            throw new Error(`Network response was not ok: ${response.status} ${response.statusText}`);
        }
        const m3u8Content = await response.text();
        if (!m3u8Content) {
            throw new Error("Playlist file is empty.");
        }
        parseM3u8(m3u8Content);
        if (playlist.length === 0) {
            throw new Error("Playlist parsed, but no valid songs were found. Check the format of juice.m3u8.");
        }
        renderPlaylist(); // Render the full playlist now that it's loaded
    } catch (error) {
        console.error("Fatal Error loading playlist:", error);
        playlistContainer.innerHTML = `
            <div class="p-4 text-center text-red-400 bg-red-900/20 rounded-lg">
                <p class="font-bold">Failed to load music library.</p>
                <p class="text-sm mt-2">Please ensure the <a href="${playlistUrl}" target="_blank" class="underline">playlist file</a> is accessible and correctly formatted. Refreshing the page might help.</p>
            </div>
        `;
        // Re-throw the error to stop the main execution if the playlist fails
        throw error;
    }
}

/**
 * Parses the text content of an M3U8 file to build the playlist array.
 */
function parseM3u8(m3u8Content) {
    const lines = m3u8Content.trim().split('\n');
    let newPlaylist = [];
    for (let i = 0; i < lines.length; i++) {
        if (lines[i].startsWith('#EXTINF:')) {
            const infoLine = lines[i];
            const urlLine = lines[i + 1];
            if (urlLine && !urlLine.startsWith('#')) {
                const durationMatch = infoLine.match(/#EXTINF:([\d\.]+)/);
                const metadataMatch = infoLine.match(/,(.+)/);

                const duration = durationMatch ? parseFloat(durationMatch[1]) : 0;
                let title = 'Unknown Title';
                let artist = 'Unknown Artist';

                if (metadataMatch) {
                    const metadata = metadataMatch[1];
                    // Handle format "Artist - [Album] Title"
                    const albumMatch = metadata.match(/(.+) - \[(.+)\] (.+)/);
                    if (albumMatch) {
                        artist = albumMatch[1].trim();
                        title = albumMatch[3].trim();
                    } else { // Handle format "Artist - Title"
                         const simpleMatch = metadata.split(' - ');
                         artist = simpleMatch[0].trim();
                         title = simpleMatch.length > 1 ? simpleMatch[1].trim() : artist;
                    }
                }
                
                newPlaylist.push({
                    id: `song_${newPlaylist.length}`,
                    title,
                    artist,
                    duration,
                    url: urlLine.trim(),
                });
                i++;
            }
        }
    }
    playlist = newPlaylist;
    console.log(`Playlist loaded successfully with ${playlist.length} songs.`);
}


// --- UI RENDERING ---

/**
 * Renders the entire playlist or a filtered version based on search text.
 */
function renderPlaylist(searchText = '') {
    playlistContainer.innerHTML = '';
    const filteredPlaylist = playlist.filter(song =>
        song.title.toLowerCase().includes(searchText.toLowerCase()) ||
        song.artist.toLowerCase().includes(searchText.toLowerCase())
    );

    if (filteredPlaylist.length === 0) {
        playlistContainer.innerHTML = `<p class="text-gray-400 p-4">No songs found.</p>`;
        return;
    }

    filteredPlaylist.forEach((song) => {
        const originalIndex = playlist.findIndex(p => p.id === song.id);
        const songEl = document.createElement('div');
        songEl.className = 'song-item flex items-center justify-between p-3 rounded-lg hover:bg-gray-800 cursor-pointer transition';
        if (originalIndex === currentIndex) {
            songEl.classList.add('active');
        }
        songEl.dataset.index = originalIndex;

        songEl.innerHTML = `
            <div class="flex items-center truncate">
                <span class="text-gray-400 w-6">${originalIndex + 1}.</span>
                <div class="truncate">
                    <p class="font-semibold truncate">${song.title}</p>
                    <p class="text-sm text-gray-400 truncate">${song.artist}</p>
                </div>
            </div>
            <span class="text-sm text-gray-400 flex-shrink-0 ml-2">${formatTime(song.duration)}</span>
        `;
        songEl.addEventListener('click', () => playSong(originalIndex));
        playlistContainer.appendChild(songEl);
    });
}

/**
 * Updates the UI for the currently playing song in the player bar and playlist.
 */
function updateActiveSongUI() {
    if (currentIndex > -1 && playlist[currentIndex]) {
        const song = playlist[currentIndex];
        playerSongTitle.textContent = song.title;
        playerSongArtist.textContent = song.artist;
        playerAlbumArt.src = `https://placehold.co/64x64/1f2937/ffffff?text=${song.title.charAt(0)}`;
        document.title = `${song.title} - EvilTwins`;

        document.querySelectorAll('.song-item').forEach(item => {
            item.classList.remove('active');
            if (parseInt(item.dataset.index) === currentIndex) {
                item.classList.add('active');
            }
        });

        downloadBtn.disabled = false;
        downloadBtn.classList.remove('text-gray-600', 'cursor-not-allowed');
    } else {
        downloadBtn.disabled = true;
        downloadBtn.classList.add('text-gray-600', 'cursor-not-allowed');
    }
}


// --- PLAYER LOGIC ---

/**
 * Plays a song from the playlist at a given index.
 */
function playSong(index) {
    if (index < 0 || index >= playlist.length) return;
    
    currentIndex = index;
    const song = playlist[index];

    if (Hls.isSupported()) {
        if (hls) hls.destroy();
        hls = new Hls();
        hls.on(Hls.Events.ERROR, function (event, data) {
            console.error('HLS.js Error:', data);
        });

        hls.loadSource(song.url);
        hls.attachMedia(audioPlayer);
        hls.on(Hls.Events.MANIFEST_PARSED, () => audioPlayer.play());
    } else if (audioPlayer.canPlayType('application/vnd.apple.mpegurl')) {
        audioPlayer.src = song.url;
        audioPlayer.addEventListener('loadedmetadata', () => audioPlayer.play());
    }
    
    updateActiveSongUI();
    fetchLyrics(song.title, song.artist);
    trackSongPlay(song);
}

function togglePlayPause() {
    if (currentIndex === -1 && playlist.length > 0) {
        playSong(0);
        return;
    }
    if (!audioPlayer.src) return;

    if (audioPlayer.paused) {
        audioPlayer.play();
    } else {
        audioPlayer.pause();
    }
}

audioPlayer.onplay = () => {
    isPlaying = true;
    playPauseIcon.className = 'fas fa-pause';
};
audioPlayer.onpause = () => {
    isPlaying = false;
    playPauseIcon.className = 'fas fa-play';
};

function playNext() {
    let nextIndex = currentIndex + 1;
    if (nextIndex >= playlist.length) nextIndex = 0;
    playSong(nextIndex);
}

function playPrev() {
    let prevIndex = currentIndex - 1;
    if (prevIndex < 0) prevIndex = playlist.length - 1;
    playSong(prevIndex);
}

// --- LYRICS ---
async function fetchLyrics(title, artist) {
    lyricsSongTitle.textContent = title;
    lyricsSongArtist.textContent = artist;
    lyricsContent.innerHTML = `<i class="fas fa-spinner fa-spin text-2xl"></i><p class="mt-2">Searching for lyrics...</p>`;
    try {
        const response = await fetch(`${geniusApiUrl}?artist=${encodeURIComponent(artist)}&title=${encodeURIComponent(title)}`);
        if (!response.ok) throw new Error('Lyrics API error.');
        const data = await response.json();
        lyricsContent.textContent = data.lyrics || "Lyrics not available for this song.";
    } catch (error) {
        console.error("Error fetching lyrics:", error);
        lyricsContent.textContent = "Could not load lyrics.";
    }
}

// --- AUTHENTICATION ---

function setupAuthObserver(auth) {
    onAuthStateChanged(auth, user => {
        currentUser = user;
        if (user) {
            renderUserProfile(user);
        } else {
            renderLoginButton();
        }
    });
}

function renderUserProfile(user) {
    userAuthContainer.innerHTML = `
        <img src="${user.photoURL || 'https://placehold.co/40x40/374151/ffffff?text=U'}" alt="User Profile" id="userProfileBtn" class="w-10 h-10 rounded-full cursor-pointer hover:ring-2 hover:ring-purple-500 transition">
    `;
    document.getElementById('userProfileBtn').addEventListener('click', () => showAccountModal(user));
}

function renderLoginButton() {
    userAuthContainer.innerHTML = `
        <button id="loginBtn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-full transition">
            Login
        </button>
    `;
    document.getElementById('loginBtn').addEventListener('click', signInWithGoogle);
}

async function signInWithGoogle() {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(window.auth, provider);
    } catch (error) {
        console.error("Error signing in with Google:", error);
    }
}

async function signOutUser() {
    try {
        await signOut(window.auth);
        accountModal.classList.add('hidden');
    } catch (error) {
        console.error("Error signing out:", error);
    }
}

function showAccountModal(user) {
    accountInfoContainer.innerHTML = `
        <div class="flex items-center space-x-4">
            <img src="${user.photoURL}" alt="Profile" class="w-16 h-16 rounded-full">
            <div>
                <p class="text-xl font-bold">${user.displayName}</p>
                <p class="text-gray-400">${user.email}</p>
            </div>
        </div>
    `;
    accountModal.classList.remove('hidden');
}

// --- FIRESTORE DATA ---

async function trackSongPlay(song) {
    if (!song || !song.title) return;
    const db = window.db;
    const songId = song.title.toLowerCase().replace(/[^a-z0-9]/g, '_');
    const songRef = doc(db, "songs", songId);
    try {
        await setDoc(songRef, {
            title: song.title,
            artist: song.artist,
            playCount: increment(1)
        }, { merge: true });
    } catch (error) {
        console.error("Error tracking song play:", error);
    }
}

function setupTopTracksListener(db) {
    const songsRef = collection(db, "songs");
    const q = query(songsRef);

    onSnapshot(q, (snapshot) => {
        let topSongs = [];
        snapshot.forEach(doc => topSongs.push({ id: doc.id, ...doc.data() }));
        
        topSongs.sort((a, b) => (b.playCount || 0) - (a.playCount || 0));
        renderTopTracks(topSongs.slice(0, 5));
    }, (error) => {
        console.error("Error getting top tracks:", error);
        let errorMessage = '<p class="text-red-400 p-2">Could not load top tracks.</p>';
        if (error.code === 'failed-precondition') {
            errorMessage = `
                <div class="p-2 text-center text-yellow-400 bg-yellow-900/20 rounded-lg text-sm">
                    <p class="font-bold">Action Required</p>
                    <p>To enable 'Most Listened', a database index needs to be created. Check the browser's developer console (F12) for a link to create it.</p>
                </div>
            `;
        }
        topTracksList.innerHTML = errorMessage;
    });
}

function renderTopTracks(songs) {
    if (songs.length === 0) {
        topTracksList.innerHTML = `<p class="text-gray-500 p-2">No listening data yet.</p>`;
        return;
    }
    topTracksList.innerHTML = '';
    songs.forEach((song, index) => {
        const trackEl = document.createElement('div');
        trackEl.className = 'flex items-center justify-between text-sm p-2 rounded hover:bg-gray-800';
        trackEl.innerHTML = `
            <div class="flex items-center truncate">
                <span class="text-gray-400 w-6">${index + 1}.</span>
                <div class="truncate">
                    <p class="font-semibold truncate">${song.title}</p>
                    <p class="text-xs text-gray-400 truncate">${song.artist}</p>
                </div>
            </div>
            <span class="text-gray-500 flex-shrink-0 ml-2"><i class="fas fa-headphones mr-1"></i> ${song.playCount}</span>
        `;
        topTracksList.appendChild(trackEl);
    });
}


// --- EVENT LISTENERS ---
function setupEventListeners() {
    playPauseBtn.addEventListener('click', togglePlayPause);
    nextBtn.addEventListener('click', playNext);
    prevBtn.addEventListener('click', playPrev);

    audioPlayer.addEventListener('timeupdate', () => {
        if (audioPlayer.duration) {
            seekBar.value = (audioPlayer.currentTime / audioPlayer.duration) * 100;
            currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
        }
    });
    audioPlayer.addEventListener('loadedmetadata', () => durationEl.textContent = formatTime(audioPlayer.duration));
    audioPlayer.addEventListener('ended', playNext);
    
    audioPlayer.addEventListener('error', (e) => {
        console.error("Audio player error:", e);
        playerSongArtist.textContent = "Error: Cannot play audio";
    });

    seekBar.addEventListener('input', () => {
        if (audioPlayer.duration) {
            audioPlayer.currentTime = (audioPlayer.value / 100) * audioPlayer.duration;
        }
    });

    volumeBar.addEventListener('input', (e) => audioPlayer.volume = e.target.value);
    searchInput.addEventListener('input', (e) => renderPlaylist(e.target.value));
    closeModalBtn.addEventListener('click', () => accountModal.classList.add('hidden'));
    logoutBtn.addEventListener('click', signOutUser);
    downloadBtn.addEventListener('click', downloadCurrentSong);
    lyricsToggleBtn.addEventListener('click', () => lyricsSection.classList.toggle('hidden'));
}

// --- UTILITY FUNCTIONS ---
function formatTime(seconds) {
    if (isNaN(seconds)) return '0:00';
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
}

async function downloadCurrentSong() {
    if (currentIndex === -1) return;
    const song = playlist[currentIndex];
    
    const originalIcon = downloadBtn.innerHTML;
    downloadBtn.innerHTML = `<i class="fas fa-spinner fa-spin"></i>`;
    downloadBtn.disabled = true;

    try {
        const response = await fetch(song.url);
        if (!response.ok) throw new Error('Network response was not ok');
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `${song.artist} - ${song.title}.mp3`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        a.remove();
    } catch (error) {
        console.error('Download failed:', error);
        alert('Could not download the song. The file URL may be invalid or blocked by a security policy.');
    } finally {
        downloadBtn.innerHTML = originalIcon;
        downloadBtn.disabled = false;
    }
}
